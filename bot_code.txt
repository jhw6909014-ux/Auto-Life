#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import os, sys, json, random, hashlib, smtplib, time
import urllib.parse
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

# [CONFIG]
RSS_KEYWORD = "home organization ideas OR cleaning hacks OR kitchen gadgets"
BLOGGER_EMAIL = "jhw6909013.Auto-Life@blogger.com"
AFFILIATE_MAP = {"default":"https://s.shopee.tw/60KPH25DnT","storage":"https://s.shopee.tw/20oGViSZtb","box":"https://s.shopee.tw/20oGViSZtb","organizer":"https://s.shopee.tw/20oGViSZtb","shelf":"https://s.shopee.tw/20oGViSZtb","vacuum":"https://s.shopee.tw/2B7gi3DO1X","mop":"https://s.shopee.tw/2B7gi3DO1X","detergent":"https://s.shopee.tw/2B7gi3DO1X","dyson":"https://s.shopee.tw/2B7gi3DO1X","pan":"https://shopee.tw/search?keyword=%E5%BB%9A%E6%88%BF","pot":"https://shopee.tw/search?keyword=%E5%BB%9A%E6%88%BF","fryer":"https://shopee.tw/search?keyword=%E5%BB%9A%E6%88%BF","kitchen":"https://shopee.tw/search?keyword=%E5%BB%9A%E6%88%BF","tefal":"https://shopee.tw/search?keyword=%E5%BB%9A%E6%88%BF","bath":"https://s.shopee.tw/9zqY2UMyST","towel":"https://s.shopee.tw/9zqY2UMyST","soap":"https://s.shopee.tw/9zqY2UMyST","toothbrush":"https://s.shopee.tw/9zqY2UMyST","appliance":"https://s.shopee.tw/3LJe6H2WeM","fan":"https://s.shopee.tw/3LJe6H2WeM","heater":"https://s.shopee.tw/3LJe6H2WeM","ac":"https://s.shopee.tw/3LJe6H2WeM","dehumidifier":"https://s.shopee.tw/3LJe6H2WeM"}
HISTORY_FILE = "history.txt"
STYLES = ["Êî∂Á¥çÂº∑Ëø´Áóá","Ê•µÁ∞°ÁîüÊ¥ªÂÆ∂","ÁúÅÈå¢ÂÆ∂‰∫ãÈÄö","Ë£ùÊΩ¢Ë®≠Ë®àÂ∏´","Â•ΩÁâ©Êé®Ëñ¶"]

def log(msg, level="INFO"):
    print(f"[{level}] {msg}")

def fail(msg):
    log(msg, "FATAL")
    sys.exit(1)

# [CHECK ENV]
try:
    import feedparser
    import google.generativeai as genai
except ImportError as e:
    fail(f"Libraries missing: {e}")

ENV = {
    "KEY": os.environ.get("GOOGLE_API_KEY"),
    "USER": os.environ.get("GMAIL_USER"),
    "PW": os.environ.get("GMAIL_APP_PASSWORD")
}
if not ENV["KEY"] or not ENV["USER"] or not ENV["PW"]: fail("Missing Secrets!")

# [RSS - URL FIX]
safe_keyword = urllib.parse.quote(RSS_KEYWORD)
rss_url = f"https://news.google.com/rss/search?q={safe_keyword}+when:1d&hl=en-US&gl=US&ceid=US:en"
log(f"Fetching RSS: {rss_url}")

feed = feedparser.parse(rss_url)
if not feed.entries:
    log("Trying fallback keyword 'technology'...", "WARN")
    feed = feedparser.parse("https://news.google.com/rss/search?q=technology+when:1d&hl=en-US&gl=US&ceid=US:en")
    if not feed.entries: fail("No news found.")

log(f"Found {len(feed.entries)} articles.")

# [HISTORY]
history = set()
if os.path.exists(HISTORY_FILE):
    with open(HISTORY_FILE, 'r') as f: history = {line.strip() for line in f}

target = None
target_tid = None
for entry in feed.entries[:5]:
    tid = hashlib.sha256(entry.title.encode()).hexdigest()
    if tid not in history:
        target = entry
        target_tid = tid
        break

if not target:
    log("All news processed.")
    sys.exit(0)

# [V21 AUTO-DETECT MODELS]
genai.configure(api_key=ENV["KEY"])
valid_model_name = None
fallback_models = ['gemini-1.5-flash', 'gemini-1.5-pro', 'gemini-1.0-pro', 'gemini-pro']

try:
    for m in genai.list_models():
        if 'generateContent' in m.supported_generation_methods:
            name = m.name.replace('models/', '')
            if 'flash' in name or 'pro' in name:
                valid_model_name = name
                break
except: pass

models_to_try = [valid_model_name] if valid_model_name else []
models_to_try.extend(fallback_models)

generated = None
prompt = f"""
Act as a blogger. Style: {random.choice(STYLES)}.
Rewrite news to Traditional Chinese (Taiwan) HTML.
News: {target.title}
Summary: {getattr(target, 'summary', '')}
Format JSON: {{ "valid": true, "title": "...", "body": "..." }}
"""

for m in models_to_try:
    if not m: continue
    log(f"Trying AI model: {m}...")
    try:
        model = genai.GenerativeModel(m)
        res = model.generate_content(prompt)
        data = json.loads(res.text.replace('```json','').replace('```',''))
        if data.get("valid"):
            generated = data
            break
    except Exception as e:
        log(f"Model {m} failed: {e}", "WARN")
        time.sleep(1)

if not generated: fail("All AI models failed.")

# [LINKING]
link = AFFILIATE_MAP["default"]
content = (generated["title"] + generated["body"]).lower()
for k, v in AFFILIATE_MAP.items():
    if k != "default" and k in content:
        link = v
        log(f"Matched keyword: {k}")
        break

# [EMAIL]
try:
    msg = MIMEMultipart()
    msg['Subject'] = generated["title"]
    msg['From'] = ENV["USER"]
    msg['To'] = BLOGGER_EMAIL
    btn = f'<br><div style="text-align:center;margin:30px;"><a href="{link}" style="background:#4f46e5;color:white;padding:12px 28px;border-radius:30px;text-decoration:none;font-weight:bold;">üëâ Êü•ÁúãÁõ∏ÈóúÂÑ™ÊÉ†</a></div>'
    msg.attach(MIMEText(generated["body"] + btn, 'html'))
    
    server = smtplib.SMTP_SSL('smtp.gmail.com', 465)
    server.login(ENV["USER"], ENV["PW"])
    server.send_message(msg)
    server.quit()
    
    with open(HISTORY_FILE, 'a') as f: f.write(target_tid + "\n")
    log("Success! Email sent.")
except Exception as e:
    fail(f"SMTP Error: {e}")
